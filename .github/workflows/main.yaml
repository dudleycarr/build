name: nsq-nightly-build
on:
  workflow_dispatch:
permissions:
  contents: write
  packages: write
env:
  NSQ_REPOSITORY: dudleycarr/nsq
  NSQ_BRANCH: fix-docker-build
jobs:
  stable-meta:
    outputs:
      NSQ_REPOSITORY: ${{ steps.latest-release.outputs.NSQ_REPOSITORY }}
      TAG: ${{ steps.latest-release.outputs.TAG }}
    runs-on: ubuntu-latest
    steps:
      # Forks for nsqio/nsq don't have tags. Always use the official repository to find
      # the most recent release.
      - name: Checkout NSQ
        uses: actions/checkout@v4
        with:
          repository: nsqio/nsq
          fetch-depth: 0
      - name: Get Tags
        run: |
          git fetch --tags origin
      - name: Get latest stable release tag
        id: latest-release
        run: |
          echo "NSQ_REPOSITORY=$NSQ_REPOSITORY" >> $GITHUB_OUTPUT
          echo "TAG=$(git describe --tags --abbrev=0)" >> $GITHUB_OUTPUT
  stable:
    needs: [stable-meta]
    name: Build latest stable release
    uses: ./.github/workflows/build.yml
    with:
      repository: ${{ needs.stable-meta.outputs.NSQ_REPOSITORY }}
      ref: ${{ needs.stable-meta.outputs.TAG }}
      release: ${{ needs.stable-meta.outputs.TAG }}
  nightly-meta:
    outputs:
      NSQ_REPOSITORY: ${{ steps.latest-commit.outputs.NSQ_REPOSITORY }}
      COMMIT_SHA: ${{ steps.latest-commit.outputs.COMMIT_SHA }}
      RELEASE_ID: ${{ steps.release-id.outputs.RELEASE_ID }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout NSQ
        uses: actions/checkout@v4
        with:
          repository: ${{ env.NSQ_REPOSITORY }}
          ref: ${{ env.NSQ_BRANCH }}
      - name: Get latest commit to main branch
        id: latest-commit
        run: |
          echo "NSQ_REPOSITORY=$NSQ_REPOSITORY" >> $GITHUB_OUTPUT
          echo "COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_OUTPUT
      - name: Generate release identifier from date
        id: release-id
        run: |
          echo "RELEASE_ID=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT
  nightly:
      needs: [nightly-meta]
      name: Build latest stable release
      uses: ./.github/workflows/build.yml
      with:
        repository: ${{ needs.nightly-meta.outputs.NSQ_REPOSITORY }}
        ref: ${{ needs.nightly-meta.outputs.COMMIT_SHA }}
        release: ${{ needs.nightly-meta.outputs.RELEASE_ID }}
